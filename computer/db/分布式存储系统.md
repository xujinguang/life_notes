## 分布式存储系统

### 系统结构

SMP的架构特点：所有资源都是共享的，CPU/内存/IO

存储系统的性能瓶颈在IO

网络拓扑：接入层，汇聚层和核心层。

### 单机存储引擎

## 第三章分布式系统

###分布式系统的问题

数据要均匀的分部在多个存储点->存储成本，数据一致性。

同样的数据，要存储多个副本，保证数据安全和高可用性，三思片刻，发现这是地球上万事万物通用的真理，比如钥匙三只起，生命绝大多数采用双链DNA。解决单点数据损害而导致数据不可用。直接副作用就是存储变成原来的好几倍，比如1TB数据，三副本，就是变成3TB。存储这些数据需要磁盘，磁盘需要花钱。所以存储成本直接就上来了。

数据存在多副本，如果对数据有修改。不能只修改一处，要修改保证多个副本都同样的修改。如果有的修改了，有的没有修改，就是数据不一致性。为什么会存在有的修改有的没有修改呢？因为这样问题的后果就是主节点数据一旦不可用，副本的数据和主副本不一致，那么它很难成为候选者来成为主副本。这样的系统的可用性是无法保证的。比如，你银行账户上有100块钱，这个数据存储三份，分别在不同的节点上。如果你往自己账号上存入或者取出一定金额之后，如果只修改主副本，没有及时同步副本，在此期间主副本数据crash，此时就是剩下两个副本还是原来的100块。如此，不是你损失就是银行损失。这是不可接受的。所以要避免这种情况发生。保证多副本数据一致性。

1. 存储成本 - 采用廉价的PC机降低存储成本，但是故障率会偏高，然后通过上层软件保证
2. 数据一致性 - Raft算法和两阶段提交协议

### 3.1 基本概念

#### 异常

分布式系统特点很多个节点通过网络连接。两个组成元素节点和网络都是不可靠的。也就是所谓异常

1. 服务宕机 - 掉电，内存错误，程序crash
2. 网络异常 - 不可达，丢包，串包，延时
3. 磁盘故障 - 磁道损害，数据错误
4. 超时 - 分布式三态：成功，失败和超时。解决超时的解决办法就是设计操作的幂等性。

#### 一致性

1. 强一致性 - 所有数据副本更新完成才算成功
2. 弱一致性 - 部分数据副处于不一致状态
3. 最终一致性 - 弱一致性的一种特例，存在一个窗口期副本处于不一致性，最终会达到一致性。
   1. 读写一致性
   2. 会话一致性
   3. 单调读
   4. 单调写
   
   从存储系统来看
   
   1. 副本一致性
   2. 更新顺序一致性

#### 衡量指标

1. 性能 - 吞吐量和系统响应能力， QPS、TPS
2. 可用性 - 几个9
3. 一致性
4. 可扩展性 - 最理想的是线性扩展

### 3.2 性能分析

性能分析的目的是为了后续的系统优化提供依据。这是重点，对比顺序操作和并发操作的性能差别。

### 3.3 数据分布

1. 哈希分布 - 一致性哈希
2. 顺序分布 

#### 哈希分布

问题：

1. 如何找到一个均匀的哈希函数 —— 尽量而为
2. 如何解决大用户数据集中 ——手动拆分
3. 扩展节点时如何数据迁移以及避免数据迁移 - 一致性哈希

### 3.4 复制

指多个副本之间的的数据同步。同步方式包括

1. 同步复制
2. 异步复制

它们的区别是是否等待副本同步完成才算成功，主副本是一定要求成功的。而副本的个数也同时有要求，比如0个，n个，全部。

在分布式系统中一致性和可用性是矛盾的。